<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/cal-heatmap/dist/cal-heatmap.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/cal-heatmap/dist/cal-heatmap.css">
    <script src="https://unpkg.com/cal-heatmap/dist/plugins/Legend.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/cal-heatmap/dist/plugins/Tooltip.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Fitness Tracker</title>
</head>

<body>
    <h1 id="plotTitle" class="text-3xl font-bold underline text-center">
        Title
    </h1>
    <div id="cal-heatmap" class="flex justify-center items-center my-4 text-lg"></div>
    <div id="legend-label" class="flex justify-center items-center"></div>
    <script>
        async function updateHeading() {
            const response = await fetch('/api/title');
            const title = await response.json();

            const heading = document.getElementById("plotTitle");

            if (title) {
                heading.innerText = title;
            }
        }

        updateHeading();
    </script>
    <script>

        // 수정사항 : 특정 날짜의 체크된 SUN 수에 따라 서로 다른 색 칠하기

        async function paintCalendar() {
            const response = await fetch('/api/daily-sports');
            const dataSet = await response.json();

            const aggregatedData = {};
            const today = new Date();
            const startOfYear = `${today.getFullYear()}-01-01`;
            const startOfDay = new Date(today.getFullYear()-1, 11, 25);
            const endOfDay = new Date(today.getFullYear(), 11, 31);

            for (let d = new Date(startOfDay); d <= endOfDay; d.setDate(d.getDate() + 1)) {
                aggregatedData[d.toISOString().split('T')[0]] = 0;
            }

            dataSet.forEach(item => {
                const date = item.date.split('T')[0];
                const sun = item.sun;
                aggregatedData[date] += sun;
            });

            const aggregatedArray = Object.keys(aggregatedData).map(date => {
                return {
                    date: date,
                    sum: aggregatedData[date]
                };
            });

            console.log(aggregatedArray);

            const maxSum = Math.max(...aggregatedArray.map(item => item.sum));
        
            const cal = new CalHeatmap();
            cal.paint({
                data: {
                    source: aggregatedArray,
                    x: "date",
                    y: "sum",
                    groupY: 'max'
                },
                domain: {
                    type: 'month',
                    gutter: 8,
                    label: {text: 'MMM', textAlign: 'middle', position: 'top'},
                    subLabel: {
                        width: 40,
                        textAlign: 'middle',
                        text: () => dayjs.weekdaysShort().map((d, i) => (i % 2 == 0 ? d : d)),
                    },
                },
                subDomain: {
                    type: 'ghDay',
                    radius: 2,
                    width: 15,
                    height: 15,
                    label: 'D',
                    gutter: 4
                },
                date: {
                    start: new Date(startOfYear)
                },
                range: 12,
                scale: {
                    opacity: {
                      baseColor: '#71b747',
                      type: 'linear',
                      domain: [0, maxSum],
                    }
                  },
            }, [
                [
                    Tooltip,
                    {
                        text: function (date, value, dayjsDate) {
                            return (
                                (value !== undefined ? value : 'No data') +
                                ' on ' +
                                dayjsDate.format('LL')
                            );
                        },
                    },
                ],
                [
                    Legend,
                    {
                        width: 400,
                        itemSelector: '#legend-label',
                    },
                ],
            ]);
        }        

        paintCalendar();
    </script>
</body>

</html>
